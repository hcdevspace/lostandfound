{% extends 'base.html' %}
{% block title %}Manage Claims{% endblock %}
{% block content %}

<div class="page-header">
    <h1><i class="fas fa-tasks"></i> Manage Claims & Inquiries</h1>
    <p class="text-muted">Review and process student claims and inquiries</p>
</div>

<!-- Filter Tabs -->
<div style="margin-bottom: 2rem;">
    <div style="border-bottom: 2px solid #dee2e6; display: flex; gap: 1rem;">
        <a href="?status=pending_approval" class="{% if current_filter == 'pending_approval' %}active-tab{% endif %}" style="padding: 0.5rem 1rem; text-decoration: none;">
            <i class="fas fa-exclamation-triangle"></i> Pending Approval
        </a>
        <a href="?status=pending" class="{% if current_filter == 'pending' %}active-tab{% endif %}" style="padding: 0.5rem 1rem; text-decoration: none;">
            Pending Claims
        </a>
        <a href="?status=approved" class="{% if current_filter == 'approved' %}active-tab{% endif %}" style="padding: 0.5rem 1rem; text-decoration: none;">
            Approved
        </a>
        <a href="?status=rejected" class="{% if current_filter == 'rejected' %}active-tab{% endif %}" style="padding: 0.5rem 1rem; text-decoration: none;">
            Rejected
        </a>
        <a href="?status=completed" class="{% if current_filter == 'completed' %}active-tab{% endif %}" style="padding: 0.5rem 1rem; text-decoration: none;">
            Completed
        </a>
        <a href="?status=all" class="{% if current_filter == 'all' %}active-tab{% endif %}" style="padding: 0.5rem 1rem; text-decoration: none;">
            All
        </a>
    </div>
</div>

<style>
    .active-tab {
        color: #007bff !important;
        border-bottom: 3px solid #007bff !important;
        font-weight: bold !important;
    }
    .active-tab:not(.active-tab) {
        color: #6c757d;
        border-bottom: 3px solid transparent;
        font-weight: normal;
    }
    a[href*="status"] {
        color: #6c757d;
        border-bottom: 3px solid transparent;
        font-weight: normal;
    }
</style>

{% if current_filter == 'pending_approval' %}
    <!-- Pending Approval Items Section -->
    {% if pending_approval_items %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            {% for item in pending_approval_items %}
            <div style="background: white; border: 2px solid #ffc107; border-radius: 8px; padding: 1.5rem; position: relative;">
                <!-- Status Badge - Top Right -->
                <div style="position: absolute; top: 1rem; right: 1rem;">
                    <span class="status-badge status-reported" style="font-size: 0.85rem; display: inline-block;">
                        <i class="fas fa-exclamation-triangle"></i> Pending
                    </span>
                </div>

                <!-- Item Image -->
                {% if item.photo %}
                <div style="margin-bottom: 1rem; text-align: center;">
                    <img src="{{ item.photo.url }}" alt="{{ item.name }}" style="max-width: 100%; max-height: 200px; border-radius: 4px; object-fit: cover;">
                </div>
                {% endif %}

                <h3 style="margin: 0 0 1rem 0; color: #333; padding-right: 100px;">{{ item.name }}</h3>

                <p style="margin: 0.5rem 0; font-size: 0.95rem;">
                    <strong><i class="fas fa-tag"></i> Category:</strong> {{ item.get_category_display }}
                </p>
                <p style="margin: 0.5rem 0; font-size: 0.95rem;">
                    <strong><i class="fas fa-map-marker-alt"></i> Location:</strong> {{ item.location_found }}
                </p>
                <p style="margin: 0.5rem 0; font-size: 0.95rem;">
                    <strong><i class="fas fa-calendar"></i> Date Found:</strong> {{ item.date_found }}
                </p>
                <p style="margin: 0.5rem 0; font-size: 0.95rem;">
                    <strong><i class="fas fa-user"></i> Reported by:</strong> {{ item.submitted_by.get_full_name|default:item.submitted_by.username }}
                </p>
                <p style="margin: 0.5rem 0; font-size: 0.95rem; color: #6c757d;">
                    <i class="fas fa-clock"></i> {{ item.created_at|timesince }} ago
                </p>

                {% if item.description %}
                <p style="margin: 1rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
                    <strong>Description:</strong><br>{{ item.description }}
                </p>
                {% endif %}

                <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                    <a href="{% url 'item_detail' item.pk %}" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                    <a href="{% url 'approve_item' item.pk %}" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-check-circle"></i> Approve
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h2>No Items Pending Approval</h2>
            <p>All reported items have been processed</p>
        </div>
    {% endif %}
{% else %}
    <!-- Claims Section -->
    {% if claims %}
        <div class="claims-list">
            {% for claim in claims %}
            <div class="claim-card" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; position: relative;">
                <div style="display: flex; justify-content: space-between; gap: 2rem; align-items: flex-start;">
                    <!-- Left: Claim Info -->
                    <div style="flex: 1; min-width: 0;">
                        <h3 style="margin: 0 0 0.5rem 0;">
                            {{ claim.item.name }}
                            <span style="font-size: 0.85rem; color: #6c757d; font-weight: normal;">
                                ({{ claim.get_claim_type_display }})
                            </span>
                        </h3>
                        <p style="margin: 0.25rem 0; color: #495057;">
                            <strong>Claimant:</strong> {{ claim.claimant.get_full_name|default:claim.claimant.username }}
                            ({{ claim.claimant.email }})
                        </p>
                        <p style="margin: 0.25rem 0; color: #495057;">
                            <strong>Contact:</strong> {{ claim.contact_method }}
                        </p>
                        <p style="margin: 0.5rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; word-wrap: break-word;">
                            <strong>Description:</strong> {{ claim.description }}
                        </p>
                        {% if claim.additional_proof %}
                        <p style="margin: 0.5rem 0; padding: 0.75rem; background: #e7f3ff; border-radius: 4px; word-wrap: break-word;">
                            <strong>Additional Proof:</strong> {{ claim.additional_proof }}
                        </p>
                        {% endif %}
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #6c757d;">
                            <i class="fas fa-clock"></i> Submitted {{ claim.created_at|timesince }} ago
                        </p>
                        {% if claim.status == 'completed' and claim.item.returned_to %}
                        <div style="margin: 0.75rem 0 0 0; padding: 0.75rem; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px; max-width: 100%;">
                            <strong style="color: #155724;"><i class="fas fa-user-check"></i> Returned to:</strong>
                            <span style="color: #155724;">{{ claim.item.returned_to.get_full_name|default:claim.item.returned_to.username }}</span>
                            <br><small style="color: #155724;">{{ claim.item.returned_to.email }}</small>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Right: Status & Actions -->
                    <div style="min-width: 200px; max-width: 200px; text-align: right; flex-shrink: 0;">
                        <span class="status-badge status-{{ claim.status }}" style="display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: bold; margin-bottom: 1rem;">
                            {{ claim.get_status_display }}
                        </span>
                        <div>
                            <a href="{% url 'review_claim' claim.pk %}" class="btn btn-primary" style="display: block; margin-bottom: 0.5rem; width: 100%;">
                                <i class="fas fa-gavel"></i> Review
                            </a>
                            <a href="{% url 'item_detail' claim.item.pk %}" class="btn btn-outline-secondary" style="display: block; width: 100%;">
                                <i class="fas fa-eye"></i> View Item
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h2>No Claims Found</h2>
            <p>No claims match the selected filter</p>
        </div>
    {% endif %}
{% endif %}

{% endblock %}
